---
layout: post
title: STM32F3Discovery-meson-example
---

We now look at the first example project [STM32F3Discovery-meson-example](https://github.com/hwengineer/STM32F3Discovery-meson-example).
It's for the [STM32F3Discovery](http://www.st.com/en/evaluation-tools/stm32f3discovery.html) Development Board from ST Semiconductor

![STM32F3Discovery Development Board](http://www.st.com/content/ccc/fragment/product_related/rpn_information/board_photo/8e/9b/f4/fd/3f/3b/4a/e7/stm32f3discovery.jpg/files/stm32f3discovery.jpg/_jcr_content/translations/en.stm32f3discovery.jpg)

## Example Project

```
├── STM32-ldscripts      # uC dependend linker files
|   ├──...
├── STM32-startup        # uC dependend startup files
|   ├──...
├── STM32Cube-F3-meson   # official ST HAL / CMIS Driver
|   ├──...
├── .gdbinit
├── .gitignore
├── .gitmodules
├── meson.build          # meson configuration file
├── cross_file.build     # meson cross-compilation configuration file
├── main.c
├── main.h
├── LICENSE
├── README.md
├── Toolchain.md
```

### linker, startup files

In the folders STM32-ldscripts and STM32-startup are microcontroller dependend
configuratio files saved.
For a running application we need to specify the rigth linker and startup scripts.
I will discuss that topic later.

### STM32 HAL Driver

In this folder we find the STM32 HAL / CMSIS Drivers from ST.
Sadly ST doesn't host a github repo at the moment. So I had to copy the files to github.
The files are under the ST LICENSE.

### meson files
To configure meson we need two files.

Normally the meson.build file is sufficient. But when we do a cross-compilation build
we need also a cross-file for defining the right compilers and special target flags.

#### cross-file
We start with the cross-file.

We have to tell meson which compilers it should use: In our case the llvm-compiler

```
[binaries]
c       = 'clang-5.0'
cpp     = 'clang++-5.0'
ld      = 'llvm-link-5.0'
ar      = 'llvm-ar-5.0'
as      = 'llvm-as-5.0'
size    = 'llvm-size-5.0'
objdump = 'llvm-objdump-5.0'
objcopy = 'arm-none-eabi-objcopy'
```

after that we have to define some compiler flags.
These are copied directly at the compilation to the specific compilers / linkers

```
[properties]
c_args      = [
               '--target=arm-none-eabi',    # define target for clang
               '-mthumb',                   # define language
               #------------------------------------
               '-fshort-enums',             # otherwise errors at linking...
               '-fmessage-length=0',        # all error warnings in a single line (default 72)
               '-fsigned-char',             # char is per default unsigned
               '-ffunction-sections',       # each function to a seperate section ==> Code-optimization / deletion
               '-fdata-sections',           # each variable to a seperate section ==> Code-optimization / deletion

               '-Weverything',
               '-ffreestanding',
               '-v', # option for more verbose output
               ]

c_link_args = [
              '--target=arm-none-eabi', # define target for linker
              '-v',                     # option for more verbose output
               '-nostdlib',             # do not import the standard library's
]
```

these are the bare minimum what we have to define for a compilation with llvm.

*okay i lied*...

you need also the `-mcpu` flag, the linker and startup files and also link the `thumbv6` or `thumbv7` runtimes.
But this will follow shortly

**back** to the cross-file.

```
[host_machine]
system     = 'none'
cpu_family = 'arm'
cpu        = 'cortex-m4'
endian     = 'little'
```

At the end we have to define our `host_machine`. Meson define the `host_machine` as the machine that runs the compilated code. And in most cases this is equal to the `target_machine`.

#### meson.build
the meson.build file defines our executable and I also added some nice features for developing with STM32 Devices.

```
project('blink', 'c',
          default_options : ['b_lto=false',
                             'b_asneeded=false'])
```

First we define the project name and default options.

And after that we define some variables.

```meson
# uController / HAL Driver dependend options
c_args     += '-DSTM32F303xC' # HAL Driver define
linkfiles   = files(['STM32-ldscripts/STM32F3/STM32F303VC.ld', 'STM32-ldscripts/simple.ld'])
startupfile = files(['STM32-startup/STM32F3/stm32f303xc.s'])
```
We have to add define flag for the compilation with the STM32Cube library.
Also we add the linkfiles and startup files.

Now follows a convenience function:

```
cpu = host_machine.cpu() == 'cortex-m0+' ? 'cortex-m0plus' : host_machine.cpu()
c_args += '-mcpu=@0@'.format( cpu )
```

we take the already define variable from the `host_machine` definition and define our compiler flag `-mcpu`
